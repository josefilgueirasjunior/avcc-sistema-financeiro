{% extends "base.html" %}

{% block title %}Categorias - Sistema Financeiro{% endblock %}

{% block content %}
<style>
    .table-fixed {
        table-layout: fixed;
        width: 100%;
    }
    
    .table-fixed th {
        font-size: 0.85rem;
        white-space: nowrap;
        padding: 0.75rem 0.5rem;
    }
    
    .table-fixed td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.9rem;
        padding: 0.75rem 0.5rem;
    }
    
    .table-fixed .nome-column {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 0;
        position: relative;
    }
    
    .table-fixed .nome-column[title]:hover {
        background-color: #f8f9fa;
        transition: background-color 0.2s ease;
    }
    
    .truncated-text {
        border-bottom: 1px dotted #6c757d;
        cursor: help;
    }
    
    .actions-column {
        white-space: nowrap;
    }
    
    .btn-group-actions {
        display: flex;
        gap: 2px;
        justify-content: center;
        align-items: center;
    }
    
    .nav-tabs {
         border-bottom: 2px solid #e9ecef;
         margin-bottom: 1.5rem;
     }
     
     .nav-tabs .nav-link {
           border-radius: 0.375rem 0.375rem 0 0;
           border: 1px solid #dee2e6;
           color: #495057;
           font-weight: 500;
           font-size: 0.85rem;
           padding: 0.5rem 0.75rem;
           margin-right: 0.15rem;
           transition: all 0.2s ease;
           background: #ffffff;
           position: relative;
           white-space: nowrap;
       }
     
     .nav-tabs .nav-link:hover {
          border-color: var(--primary-color);
          background: #f8f9fa;
          color: var(--primary-color);
          transform: translateY(-1px);
      }
      
      .nav-tabs .nav-link.active {
          background: var(--primary-color);
          border-color: var(--primary-color);
          color: white;
          box-shadow: 0 2px 4px rgba(229, 83, 115, 0.2);
          transform: translateY(-1px);
      }
     
     .nav-tabs .nav-link.active::after {
         content: '';
         position: absolute;
         bottom: -2px;
         left: 0;
         right: 0;
         height: 2px;
         background: var(--primary-color);
     }
     
     .nav-tabs .nav-link i {
           margin-right: 0.3rem;
           font-size: 0.8rem;
       }
    
    /* Responsividade para dispositivos móveis */
    @media (max-width: 768px) {
        .table-fixed {
            font-size: 0.8rem;
        }
        
        .table-fixed th {
            font-size: 0.75rem;
            padding: 0.4rem 0.2rem;
        }
        
        .table-fixed td {
            font-size: 0.8rem;
            padding: 0.5rem 0.3rem;
        }
        
        .page-header {
            margin-bottom: 1rem !important;
        }
        
        .page-title {
            font-size: 1.5rem;
        }
        
        .page-subtitle {
            font-size: 0.9rem;
        }
        
        .nav-tabs {
             flex-wrap: wrap;
             margin-bottom: 1rem;
         }
         
         .nav-tabs .nav-link {
              font-size: 0.75rem;
              padding: 0.4rem 0.6rem;
              margin-right: 0.1rem;
              margin-bottom: 0;
          }
          
          .nav-tabs .nav-link i {
              font-size: 0.75rem;
              margin-right: 0.25rem;
          }
          
          .nav-tabs .nav-link span {
              font-size: 0.75rem;
          }
    }
    
    @media (max-width: 576px) {
        .table-fixed th:nth-child(2),
        .table-fixed td:nth-child(2) {
            display: none;
        }
        
        .table-fixed th {
            font-size: 0.7rem;
            padding: 0.3rem 0.15rem;
        }
        
        .table-fixed td {
            font-size: 0.75rem;
            padding: 0.4rem 0.2rem;
        }
        
        .btn-group-actions .btn {
            padding: 0.25rem 0.4rem;
            font-size: 0.75rem;
        }
        
        .nav-tabs .nav-link {
              font-size: 0.65rem;
              padding: 0.35rem 0.4rem;
              margin-right: 0.05rem;
              margin-bottom: 0;
          }
          
          .nav-tabs .nav-link i {
              font-size: 0.65rem;
              margin-right: 0.2rem;
          }
          
          .nav-tabs .nav-link span {
              display: none;
          }
          
          .nav-tabs .nav-link::after {
              content: attr(data-short-title);
              font-size: 0.65rem;
          }
    }
</style>

<div class="page-header mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
            <h1 class="page-title">Categorias</h1>
            <p class="page-subtitle">Configure as categorias utilizadas no sistema</p>
        </div>
    </div>
</div>

<!-- Tabs para diferentes tipos de categoria -->
<ul class="nav nav-tabs" id="categoriaTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pagar-tab" data-bs-toggle="tab" data-bs-target="#pagar" type="button" role="tab" data-short-title="Pagar">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Categorias a Pagar</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tipos-pagamento-tab" data-bs-toggle="tab" data-bs-target="#tipos-pagamento" type="button" role="tab" data-short-title="Tipos">
            <i class="fas fa-credit-card"></i>
            <span>Tipos de Pagamento</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="receber-tab" data-bs-toggle="tab" data-bs-target="#receber" type="button" role="tab" data-short-title="Receber">
            <i class="fas fa-hand-holding-usd"></i>
            <span>Categorias a Receber</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="origens-tab" data-bs-toggle="tab" data-bs-target="#origens" type="button" role="tab" data-short-title="Origens">
            <i class="fas fa-map-marker-alt"></i>
            <span>Origens de Receber</span>
        </button>
    </li>
</ul>

<div class="tab-content" id="categoriaTabContent">
    <!-- Tab Categorias a Pagar -->
    <div class="tab-pane fade show active" id="pagar" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Categorias a Pagar</h5>
                <button class="btn btn-primary btn-sm rounded-1 px-3 py-2" onclick="showAddModal('pagar')">
                    <i class="fas fa-plus me-1"></i>Adicionar
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-fixed">
                        <thead>
                            <tr>
                                <th style="width: 40%; padding: 0.75rem 0.5rem;">Nome</th>
                                <th style="width: 45%; padding: 0.75rem 0.5rem;">Descrição</th>
                                <th style="width: 15%; padding: 0.75rem 0.5rem;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="pagarTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Tipos de Pagamento -->
    <div class="tab-pane fade" id="tipos-pagamento" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Tipos de Pagamento</h5>
                <button class="btn btn-primary btn-sm rounded-1 px-3 py-2" onclick="showAddModal('tipos-pagamento')">
                    <i class="fas fa-plus me-1"></i>Adicionar
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-fixed">
                        <thead>
                            <tr>
                                <th style="width: 40%; padding: 0.75rem 0.5rem;">Nome</th>
                                <th style="width: 45%; padding: 0.75rem 0.5rem;">Descrição</th>
                                <th style="width: 15%; padding: 0.75rem 0.5rem;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tiposPagamentoTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Categorias a Receber -->
    <div class="tab-pane fade" id="receber" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Categorias a Receber</h5>
                <button class="btn btn-primary btn-sm rounded-1 px-3 py-2" onclick="showAddModal('receber')">
                    <i class="fas fa-plus me-1"></i>Adicionar
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-fixed">
                        <thead>
                            <tr>
                                <th style="width: 40%; padding: 0.75rem 0.5rem;">Nome</th>
                                <th style="width: 45%; padding: 0.75rem 0.5rem;">Descrição</th>
                                <th style="width: 15%; padding: 0.75rem 0.5rem;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="receberTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Origens de Receber -->
    <div class="tab-pane fade" id="origens" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Origens de Receber</h5>
                <button class="btn btn-primary btn-sm rounded-1 px-3 py-2" onclick="showAddModal('origens')">
                    <i class="fas fa-plus me-1"></i>Adicionar
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-fixed">
                        <thead>
                            <tr>
                                <th style="width: 40%; padding: 0.75rem 0.5rem;">Nome</th>
                                <th style="width: 45%; padding: 0.75rem 0.5rem;">Descrição</th>
                                <th style="width: 15%; padding: 0.75rem 0.5rem;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="origensTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar/Editar -->
<div class="modal fade" id="categoriaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: var(--primary-color);">
                <h5 class="modal-title" id="modalTitle"><i class="fas fa-plus me-2"></i>Adicionar Categoria</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="categoriaForm">
                    <input type="hidden" id="categoriaId">
                    <input type="hidden" id="categoriaType">
                    
                    <!-- Seção: Informações da Categoria -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-tag me-2"></i>Informações da Categoria
                            </h6>
                        </div>
                        <div class="col-lg-6 col-md-6 mb-3">
                            <label for="nome" class="form-label fw-semibold">Nome *</label>
                            <input type="text" class="form-control" id="nome" required placeholder="Digite o nome da categoria">
                        </div>
                        <div class="col-lg-6 col-md-6 mb-3">
                            <label for="descricao" class="form-label fw-semibold">Descrição</label>
                            <textarea class="form-control" id="descricao" rows="3" placeholder="Descrição opcional da categoria..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn rounded-1" style="border: 1px solid var(--primary-color); color: var(--primary-color);" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn rounded-1 text-white" style="background: var(--primary-color); border: var(--primary-color);" onclick="saveCategoria()">
                    <i class="fas fa-save me-1"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentType = 'pagar';
    
    const typeConfig = {
        'pagar': {
            endpoint: '/api/categorias-pagar',
            title: 'Categoria a Pagar',
            tableBody: 'pagarTableBody'
        },
        'tipos-pagamento': {
            endpoint: '/api/tipos-pagamento',
            title: 'Tipo de Pagamento',
            tableBody: 'tiposPagamentoTableBody'
        },
        'receber': {
            endpoint: '/api/categorias-receber',
            title: 'Categoria a Receber',
            tableBody: 'receberTableBody'
        },
        'origens': {
            endpoint: '/api/origens-receber',
            title: 'Origem de Receber',
            tableBody: 'origensTableBody'
        }
    };

    document.addEventListener("DOMContentLoaded", function() {
        if (checkAuth()) {
            loadAllCategories();
            
            // Event listeners para as tabs
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (e) {
                    const targetId = e.target.getAttribute('data-bs-target').substring(1);
                    currentType = targetId === 'tipos-pagamento' ? 'tipos-pagamento' : targetId;
                });
            });
        }
    });

    async function loadAllCategories() {
        for (const type in typeConfig) {
            await loadCategories(type);
        }
    }

    async function loadCategories(type) {
        try {
            const response = await fetchWithAuth(typeConfig[type].endpoint);
            if (response && response.ok) {
                const data = await response.json();
                renderTable(type, data);
            } else {
                console.error(`Erro ao carregar ${type}`);
            }
        } catch (error) {
            console.error(`Erro ao carregar ${type}:`, error);
        }
    }

    function renderTable(type, data) {
        const tableBody = document.getElementById(typeConfig[type].tableBody);
        tableBody.innerHTML = "";

        data.forEach(item => {
            const row = document.createElement("tr");
            
            const nomeDisplay = truncateText(item.nome, 30);
            const isNameTruncated = item.nome.length > 30;
            
            const descricaoDisplay = truncateText(item.descricao || '', 40);
            const isDescricaoTruncated = (item.descricao || '').length > 40;
            
            row.innerHTML = `
                <td class="nome-column" title="${item.nome}">
                    <span class="${isNameTruncated ? 'truncated-text' : ''}">${nomeDisplay}</span>
                </td>
                <td class="nome-column" title="${item.descricao || 'Não informado'}">
                    <span class="${isDescricaoTruncated ? 'truncated-text' : ''}">${descricaoDisplay || '-'}</span>
                </td>
                <td class="actions-column">
                    <div class="btn-group-actions">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategoria('${type}', ${item.id})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    function truncateText(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    function showAddModal(type) {
        currentType = type;
        document.getElementById("modalTitle").innerHTML = `<i class="fas fa-plus me-2"></i>Adicionar ${typeConfig[type].title}`;
        document.getElementById("categoriaForm").reset();
        document.getElementById("categoriaId").value = "";
        document.getElementById("categoriaType").value = type;
        new bootstrap.Modal(document.getElementById("categoriaModal")).show();
    }

    async function saveCategoria() {
        const form = document.getElementById("categoriaForm");
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const type = document.getElementById("categoriaType").value;
        const data = {
            nome: document.getElementById("nome").value,
            descricao: document.getElementById("descricao").value || null
        };

        try {
            const response = await fetchWithAuth(typeConfig[type].endpoint, {
                method: "POST",
                body: JSON.stringify(data)
            });

            if (response && response.ok) {
                showSuccess(`${typeConfig[type].title} cadastrada com sucesso!`);
                bootstrap.Modal.getInstance(document.getElementById("categoriaModal")).hide();
                loadCategories(type);
            } else {
                const errorData = await response.json();
                showError(`Erro ao salvar: ${errorData.detail}`);
            }
        } catch (error) {
            console.error("Erro:", error);
            showError("Erro ao conectar com o servidor");
        }
    }

    async function deleteCategoria(type, id) {
        if (confirm(`Tem certeza que deseja excluir esta ${typeConfig[type].title.toLowerCase()}?`)) {
            try {
                const response = await fetchWithAuth(`${typeConfig[type].endpoint}/${id}`, {
                    method: "DELETE"
                });

                if (response && response.ok) {
                    showSuccess(`${typeConfig[type].title} excluída com sucesso!`);
                    loadCategories(type);
                } else {
                    showError("Erro ao excluir categoria");
                }
            } catch (error) {
                console.error("Erro:", error);
                showError("Erro ao conectar com o servidor");
            }
        }
    }
</script>
{% endblock %}

