{% extends "base.html" %}

{% block title %}Contas a Receber - Sistema Financeiro{% endblock %}

{% block extra_css %}
<style>
    .form-label-sm {
        font-size: 0.75rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .filter-section .bg-light {
        background-color: #f8f9fa !important;
        border: 1px solid #e9ecef;
    }
    
    .filter-section .form-control-sm:focus,
    .filter-section .form-select-sm:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb), 0.25);
    }
    
    .filter-section hr {
        border-color: #dee2e6;
        margin: 0.5rem 0;
    }
    
    .filter-section .text-muted {
        color: #6c757d !important;
        font-size: 0.8rem;
    }
    
    .table-fixed {
        table-layout: fixed;
        width: 100%;
    }
    
    .table-fixed th {
        font-size: 0.85rem;
        white-space: nowrap;
        padding: 0.5rem 0.25rem;
    }
    
    .table-fixed td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.9rem;
    }
    
    .table-fixed .nome-column {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 0;
        position: relative;
    }
    
    .table-fixed .nome-column[title]:hover {
        background-color: #f8f9fa;
        transition: background-color 0.2s ease;
    }
    
    .truncated-text {
        border-bottom: 1px dotted #6c757d;
        cursor: help;
    }
    
    .actions-column {
        white-space: nowrap;
    }
    
    .btn-group-actions {
        display: flex;
        gap: 2px;
        justify-content: center;
        align-items: center;
    }
    
    /* Responsividade para dispositivos móveis */
    @media (max-width: 768px) {
        .table-fixed {
            font-size: 0.8rem;
        }
        
        .table-fixed th {
            font-size: 0.75rem;
            padding: 0.4rem 0.2rem;
        }
        
        .table-fixed td {
            font-size: 0.8rem;
            padding: 0.5rem 0.3rem;
        }
        
        /* Ocultar colunas menos importantes em mobile */
        .table-fixed .hide-mobile {
            display: none;
        }
        
        /* Ajustar larguras das colunas em mobile */
        .table-fixed th:nth-child(1) { width: 60px !important; } /* Status */
        .table-fixed th:nth-child(2) { width: 140px !important; } /* Nome/Razão */
        .table-fixed th:nth-child(3) { width: 120px !important; } /* Venc/Valor */
        .table-fixed th:nth-child(4) { width: 100px !important; } /* Ações */
        
        .btn-group-actions {
            flex-direction: row;
            gap: 2px;
            flex-wrap: wrap;
        }
        
        .btn-group-actions .btn {
            padding: 0.2rem 0.3rem;
            font-size: 0.7rem;
            min-width: 28px;
        }
        
        .btn-group-actions .btn i {
            font-size: 0.8rem;
        }
    }
    
    @media (max-width: 576px) {
        .table-fixed th {
            font-size: 0.7rem;
            padding: 0.35rem 0.15rem;
        }
        
        .table-fixed td {
            font-size: 0.75rem;
            padding: 0.4rem 0.2rem;
        }
        
        /* Ajustar larguras para telas muito pequenas */
        .table-fixed th:nth-child(1) { width: 50px !important; } /* Status */
        .table-fixed th:nth-child(2) { width: 120px !important; } /* Nome/Razão */
        .table-fixed th:nth-child(3) { width: 110px !important; } /* Venc/Valor */
        .table-fixed th:nth-child(4) { width: 90px !important; } /* Ações */
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Contas a Receber</h1>
            <p class="page-subtitle">Gerencie as receitas e contas a receber da associação</p>
        </div>
        <button class="btn btn-primary btn-sm rounded-1 px-3 py-2 flex-shrink-0" onclick="abrirModal()">
            <i class="fas fa-plus me-1"></i>
            <span class="d-none d-md-inline">Adicionar Nova</span>
            <span class="d-md-none">Adicionar</span>
        </button>
    </div>
</div>

<div class="filter-section mb-2">
    <div class="d-flex justify-content-between align-items-center mb-1">
        <small class="fw-semibold" style="color: var(--primary-color);">
            <i class="fas fa-filter me-1"></i>Filtros
        </small>
        <button class="btn btn-outline-primary btn-sm rounded-1 py-0 px-2" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
            <i class="fas fa-chevron-down" id="filterToggleIcon" style="font-size: 0.7rem;"></i>
        </button>
    </div>
    
    <div class="collapse" id="filterCollapse">
        <div class="bg-light rounded px-3 py-2">
            <!-- Filtros Básicos -->
            <div class="mb-2">
                <small class="text-muted fw-semibold d-block mb-1">
                    <i class="fas fa-search me-1"></i>Filtros Básicos
                </small>
                <div class="row g-2">
                    <div class="col-lg-2 col-md-3">
                        <label class="form-label form-label-sm mb-1">Status</label>
                        <select class="form-select form-select-sm" id="filterStatus" onchange="aplicarFiltros()">
                            <option value="">Todos Status</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Recebido">Recebido</option>
                        </select>
                    </div>
                    <div class="col-lg-6 col-md-5">
                        <label class="form-label form-label-sm mb-1">Nome/Razão</label>
                        <input type="text" class="form-control form-control-sm" id="filterNomeRazao" placeholder="Nome/Razão..." onkeyup="aplicarFiltros()">
                    </div>
                    <div class="col-lg-4 col-md-4">
                        <label class="form-label form-label-sm mb-1">Período de Vencimento</label>
                        <input type="text" class="form-control form-control-sm" id="filterPeriodoVencimento" placeholder="Selecionar período..." readonly onclick="abrirCalendarioPeriodo()">
                        <input type="hidden" id="dataVencimentoInicio">
                        <input type="hidden" id="dataVencimentoFim">
                    </div>
                </div>
            </div>
            
            <!-- Divisor -->
            <hr class="my-2" style="opacity: 0.3;">
            
            <!-- Filtros Avançados -->
            <div class="mb-2">
                <small class="text-muted fw-semibold d-block mb-1">
                    <i class="fas fa-sliders-h me-1"></i>Filtros Avançados
                </small>
                <div class="row g-2">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label form-label-sm mb-1">Categorias</label>
                        <input type="text" class="form-control form-control-sm" id="filterCategoria" placeholder="Selecionar categorias..." readonly onclick="abrirModalCategorias()">
                        <input type="hidden" id="categoriasSelecionadas">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label form-label-sm mb-1">Origens</label>
                        <input type="text" class="form-control form-control-sm" id="filterOrigem" placeholder="Selecionar origens..." readonly onclick="abrirModalOrigens()">
                        <input type="hidden" id="origensSelecionadas">
                    </div>
                    <div class="col-lg-6 col-md-12">
                        <label class="form-label form-label-sm mb-1">Contas/Bancos</label>
                        <input type="text" class="form-control form-control-sm" id="filterConta" placeholder="Selecionar contas..." readonly onclick="abrirModalContas()">
                        <input type="hidden" id="contasSelecionadas">
                    </div>
                </div>
            </div>
            
            <!-- Botão Limpar -->
            <div class="text-center pt-1">
                <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="limparFiltros()">
                    <i class="fas fa-times me-1" style="font-size: 0.7rem;"></i>Limpar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

<div class="loading" id="loading">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <p>Carregando contas a receber...</p>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-fixed">
                <thead>
                    <tr>
                        <th style="width: 80px;">Status</th>
                        <th class="hide-mobile" style="width: 150px;">Origem/Emissão</th>
                        <th style="width: 200px;">Nome/Razão</th>
                        <th class="hide-mobile" style="width: 180px;">Conta/Categ</th>
                        <th style="width: 140px;">Venc/Valor</th>
                        <th style="width: 120px;">Ações</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="recordCount">0 registros encontrados</span>
                <span id="totalValue" class="ms-3 fw-bold text-success"></span>
            </div>
            <div>
                <nav>
                    <ul class="pagination" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar/Editar -->
<div class="modal fade" id="contaReceberModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: var(--primary-color);">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-plus-circle me-2"></i>Adicionar Conta a Receber
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="contaReceberForm">
                    <input type="hidden" id="contaReceberId">
                    
                    <!-- Seção: Informações Básicas -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-info-circle me-2"></i>Informações Básicas
                            </h6>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <label for="origem" class="form-label fw-semibold">Origem *</label>
                            <select class="form-select" id="origem" required>
                                <option value="">Selecione a origem</option>
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <label for="fornecedor_doador_id" class="form-label fw-semibold">Fornecedor/Doador *</label>
                            <select class="form-select" id="fornecedor_doador_id" required>
                                <option value="">Selecione um Fornecedor/Doador</option>
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-12 mb-3">
                            <label for="conta_id" class="form-label fw-semibold">Conta/Banco *</label>
                            <select class="form-select" id="conta_id" required>
                                <option value="">Selecione a conta</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Seção: Categoria e Valores -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-tags me-2"></i>Categoria e Valores
                            </h6>
                        </div>
                        <div class="col-lg-6 col-md-6 mb-3">
                            <label for="categoria" class="form-label fw-semibold">Categoria *</label>
                            <select class="form-select" id="categoria" required>
                                <option value="">Selecione a categoria</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label for="status" class="form-label fw-semibold">Status *</label>
                            <select class="form-select" id="status" required onchange="controlarDataRecebimento()">
                                <option value="Pendente">Pendente</option>
                                <option value="Recebido">Recebido</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label for="valor" class="form-label fw-semibold">Valor *</label>
                            <input type="text" class="form-control" id="valor" required placeholder="0,00" oninput="formatarValor(this)">
                        </div>
                    </div>
                    
                    <!-- Seção: Datas -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-calendar-alt me-2"></i>Datas
                            </h6>
                        </div>
                        <div class="col-lg-4 col-md-4 mb-3">
                            <label for="data_emissao" class="form-label fw-semibold">Data Emissão *</label>
                            <input type="date" class="form-control" id="data_emissao" required>
                        </div>
                        <div class="col-lg-4 col-md-4 mb-3">
                            <label for="data_vencimento" class="form-label fw-semibold">Data Vencimento *</label>
                            <input type="date" class="form-control" id="data_vencimento" required>
                        </div>
                        <div class="col-lg-4 col-md-4 mb-3">
                            <label for="data_recebimento" class="form-label fw-semibold">Data Recebimento</label>
                            <input type="date" class="form-control" id="data_recebimento">
                        </div>
                    </div>
                    
                    <!-- Seção: Recorrência -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-redo me-2"></i>Recorrência
                            </h6>
                        </div>
                        <div class="col-lg-6 col-md-6 mb-3">
                            <label class="form-label fw-semibold">Opções de Recorrência</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="recorrente" onchange="toggleRecorrencia()">
                                <label class="form-check-label" for="recorrente">
                                    <i class="fas fa-redo me-1"></i>Receita recorrente
                                </label>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 mb-3" id="recorrenciaSection" style="display: none;">
                            <label for="meses_repetir" class="form-label fw-semibold">Repetir por quantos meses?</label>
                            <input type="number" class="form-control" id="meses_repetir" min="1" max="12" placeholder="Ex: 6">
                            <div class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>Máximo 12 meses
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção: Observações -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3" style="color: var(--primary-color);">
                                <i class="fas fa-sticky-note me-2"></i>Observações
                            </h6>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="observacao" class="form-label fw-semibold">Observações Gerais</label>
                            <textarea class="form-control" id="observacao" rows="3" placeholder="Informações adicionais sobre a conta a receber..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn rounded-1" style="border: 1px solid var(--primary-color); color: var(--primary-color);" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn rounded-1 text-white" style="background: var(--primary-color); border: var(--primary-color);" onclick="salvarConta()">
                    <i class="fas fa-save me-1"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let contasReceber = [];
let paginaAtual = 1;
let registrosPorPagina = 10;

// Função para abrir o modal
function abrirModal() {
    document.getElementById('modalTitle').textContent = 'Adicionar Conta a Receber';
    document.getElementById('contaReceberForm').reset();
    document.getElementById('contaReceberId').value = '';
    document.getElementById('data_emissao').value = new Date().toISOString().split('T')[0];
    document.getElementById('recorrenciaSection').style.display = 'none';
    
    carregarDadosDropdowns();
    
    const modal = new bootstrap.Modal(document.getElementById('contaReceberModal'));
    modal.show();
}

// Função para carregar dados dos dropdowns
async function carregarDadosDropdowns() {
    const token = localStorage.getItem('access_token');
    const headers = { 
        'Authorization': 'Bearer ' + token, 
        'Content-Type': 'application/json' 
    };
    
    try {
        // Carregar Fornecedores/Doadores
        const fornecedoresResp = await fetch('/api/fornecedores-doadores', { headers });
        if (fornecedoresResp.ok) {
            const data = await fornecedoresResp.json();
            // A API agora retorna dados paginados
            const fornecedores = data.items || data;
            const selectFornecedor = document.getElementById('fornecedor_doador_id');
            selectFornecedor.innerHTML = '<option value="">Selecione um Fornecedor/Doador</option>';
            fornecedores.forEach(fd => {
                const option = document.createElement('option');
                option.value = fd.id;
                option.textContent = fd.nome_razao;
                selectFornecedor.appendChild(option);
            });
        }
        
        // Carregar Contas
        const contasResp = await fetch('/api/contas', { headers });
        if (contasResp.ok) {
            const contas = await contasResp.json();
            const selectConta = document.getElementById('conta_id');
            selectConta.innerHTML = '<option value="">Selecione a conta</option>';
            contas.forEach(conta => {
                const option = document.createElement('option');
                option.value = conta.id;
                option.textContent = conta.nome_conta;
                selectConta.appendChild(option);
            });
        }
        
        // Carregar Categorias
        const categoriasResp = await fetch('/api/categorias-receber', { headers });
        if (categoriasResp.ok) {
            const categorias = await categoriasResp.json();
            const selectCategoria = document.getElementById('categoria');
            selectCategoria.innerHTML = '<option value="">Selecione a categoria</option>';
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.nome;
                option.textContent = cat.nome;
                selectCategoria.appendChild(option);
            });
        }
        
        // Carregar Origens
        const origensResp = await fetch('/api/origens-receber', { headers });
        if (origensResp.ok) {
            const origens = await origensResp.json();
            const selectOrigens = document.getElementById('origem');
            selectOrigens.innerHTML = '<option value="">Selecione a origem</option>';
            origens.forEach(origem => {
                const option = document.createElement('option');
                option.value = origem.nome;
                option.textContent = origem.nome;
                selectOrigens.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Erro ao carregar dados dos dropdowns:', error);
        showError('Erro ao carregar dados dos formulários');
    }
}

// Função para salvar conta
async function salvarConta() {
    const form = document.getElementById('contaReceberForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const id = document.getElementById('contaReceberId').value;
    const data = {
        origem: document.getElementById('origem').value,
        fornecedor_doador_id: parseInt(document.getElementById('fornecedor_doador_id').value),
        conta_id: parseInt(document.getElementById('conta_id').value),
        categoria: document.getElementById('categoria').value,
        status: document.getElementById('status').value,
        valor: parseFloat(document.getElementById('valor').value),
        data_emissao: document.getElementById('data_emissao').value,
        data_vencimento: document.getElementById('data_vencimento').value,
        data_recebimento: document.getElementById('data_recebimento').value || null,
        recorrente: document.getElementById('recorrente').checked,
        meses_repetir: document.getElementById('recorrente').checked ? parseInt(document.getElementById('meses_repetir').value) || null : null,
        observacao: document.getElementById('observacao').value
    };

    try {
        let response;
        if (id) {
            response = await fetchWithAuth(`/api/contas-receber/${id}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
        } else {
            response = await fetchWithAuth('/api/contas-receber', {
                method: 'POST',
                body: JSON.stringify(data)
            });
        }

        if (response && response.ok) {
            showSuccess(id ? 'Conta a receber atualizada com sucesso!' : 'Conta a receber cadastrada com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('contaReceberModal')).hide();
            carregarContasReceber();
        } else {
            showError('Erro ao salvar conta a receber');
        }
    } catch (error) {
        console.error('Erro:', error);
        showError('Erro ao conectar com o servidor');
    }
}

// Função para carregar contas a receber
async function carregarContasReceber() {
    document.getElementById('loading').style.display = 'block';
    
    try {
        // Garantir que os dados dos filtros estejam carregados primeiro
        if (contasDisponiveis.length === 0) {
            await carregarDadosFiltros();
        }
        
        const response = await fetchWithAuth('/api/contas-receber');
        if (response && response.ok) {
            contasReceber = await response.json();
            renderizarTabela();
        } else {
            showError('Erro ao carregar contas a receber');
        }
    } catch (error) {
        console.error('Erro:', error);
        showError('Erro ao conectar com o servidor');
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// Função para renderizar tabela
function renderizarTabela() {
    const tableBody = document.getElementById('tableBody');
    const startIndex = (paginaAtual - 1) * registrosPorPagina;
    const endIndex = startIndex + registrosPorPagina;
    const contasPagina = contasReceber.slice(startIndex, endIndex);

    tableBody.innerHTML = '';

    if (contasPagina.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10" class="text-center">Nenhuma conta encontrada</td></tr>';
    } else {
        contasPagina.forEach(conta => {
            const row = document.createElement('tr');
            
            // Determinar o nome da conta
            let nomeConta = '';
            if (conta.conta && conta.conta.nome_conta) {
                nomeConta = conta.conta.nome_conta;
            } else if (conta.conta_id && contasDisponiveis && contasDisponiveis.length > 0) {
                // Buscar o nome da conta pelos dados carregados
                const contaEncontrada = contasDisponiveis.find(c => c.id == conta.conta_id);
                nomeConta = contaEncontrada ? contaEncontrada.nome_conta : '-';
            } else {
                nomeConta = '-';
            }
            
            const fornecedorNome = conta.fornecedor_doador ? conta.fornecedor_doador.nome_razao : 'N/A';
            const categoriaNome = conta.categoria || 'N/A';
            
            row.innerHTML = `
                <td class="text-center">
                    <div>
                        <span class="badge ${conta.status === 'Recebido' ? 'bg-success' : 'bg-warning text-dark'} rounded-1 px-2 py-1" title="${conta.status}">
                            ${conta.status === 'Recebido' ? 'R' : 'P'}
                        </span>
                    </div>
                    ${conta.status === 'Recebido' && conta.data_recebimento ? `<div class="small text-muted mt-1">${formatarData(conta.data_recebimento)}</div>` : ''}
                </td>
                <td class="nome-column hide-mobile" title="${conta.origem} - ${formatarData(conta.data_emissao)}">
                    <div><span class="${conta.origem.length > 15 ? 'truncated-text' : ''}">${truncateText(conta.origem, 15)}</span></div>
                    <div class="small text-muted">${formatarData(conta.data_emissao)}</div>
                </td>
                <td class="nome-column" title="${fornecedorNome}">
                    <span class="${fornecedorNome.length > 25 ? 'truncated-text' : ''}">${truncateText(fornecedorNome, 25)}</span>
                </td>
                <td class="nome-column hide-mobile" title="${nomeConta} - ${categoriaNome}">
                    <div><span class="${nomeConta.length > 20 ? 'truncated-text' : ''}">${truncateText(nomeConta, 20)}</span></div>
                    <div class="small text-muted">${truncateText(categoriaNome, 20)}</div>
                </td>
                <td>
                    <div>${formatarData(conta.data_vencimento)}${conta.parcela_total > 1 ? ` (${conta.parcela_numero}/${conta.parcela_total})` : ''}</div>
                    <div class="fw-bold text-primary">R$ ${parseFloat(conta.valor).toFixed(2)}</div>
                </td>
                <td class="actions-column">
                    <div class="btn-group-actions">
                        ${conta.status === 'Pendente' ? `
                        <button class="btn btn-sm btn-outline-primary" onclick="editarConta(${conta.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="receberConta(${conta.id})" title="Marcar como Recebida">
                            <i class="fas fa-check"></i>
                        </button>
                        ` : `
                        <button class="btn btn-sm btn-outline-primary" onclick="editarConta(${conta.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        `}
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirConta(${conta.id})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Atualizar contador
    document.getElementById('recordCount').textContent = `${contasReceber.length} registros encontrados`;
    
    // Calcular total
    const total = contasReceber.reduce((sum, conta) => sum + parseFloat(conta.valor), 0);
    document.getElementById('totalValue').textContent = `Total: R$ ${total.toFixed(2)}`;
}

// Função para formatar data
function formatarData(dataString) {
    if (!dataString) return '';
    const data = new Date(dataString + 'T00:00:00');
    return data.toLocaleDateString('pt-BR');
}

// Função para truncar texto
function truncateText(text, maxLength = 30) {
    if (!text || text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// Função para controlar data de recebimento
function controlarDataRecebimento() {
    const status = document.getElementById('status').value;
    const dataRecebimentoField = document.getElementById('data_recebimento');
    const recorrenteCheckbox = document.getElementById('recorrente');
    const recorrenciaSection = document.getElementById('recorrenciaSection');
    
    if (status === 'Recebido') {
        if (!dataRecebimentoField.value) {
            dataRecebimentoField.value = new Date().toISOString().split('T')[0];
        }
        dataRecebimentoField.required = true;
        dataRecebimentoField.disabled = false;
        
        // Ocultar e limpar recorrência quando status for Recebido
        recorrenteCheckbox.checked = false;
        recorrenciaSection.style.display = 'none';
        document.getElementById('meses_repetir').value = '';
        recorrenteCheckbox.disabled = true;
        // Ocultar toda a seção de recorrência
        document.querySelector('.col-lg-6.col-md-6.mb-3:has(#recorrente)').style.display = 'none';
    } else {
        dataRecebimentoField.value = '';
        dataRecebimentoField.required = false;
        dataRecebimentoField.disabled = true;
        
        // Habilitar recorrência quando status for Pendente
        recorrenteCheckbox.disabled = false;
        // Mostrar toda a seção de recorrência
        document.querySelector('.col-lg-6.col-md-6.mb-3:has(#recorrente)').style.display = 'block';
    }
}

// Função para formatar valor
function formatarValor(input) {
    let valor = input.value.replace(/\D/g, '');
    valor = (valor / 100).toFixed(2) + '';
    valor = valor.replace('.', ',');
    valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, '$1.$2.$3,');
    valor = valor.replace(/(\d)(\d{3}),/g, '$1.$2,');
    input.value = valor;
}

// Função para controlar exibição da seção de recorrência
function toggleRecorrencia() {
    const recorrenteCheckbox = document.getElementById('recorrente');
    const recorrenciaSection = document.getElementById('recorrenciaSection');
    
    if (recorrenteCheckbox.checked) {
        recorrenciaSection.style.display = 'block';
    } else {
        recorrenciaSection.style.display = 'none';
        // Limpar todos os dados da seção de recorrência
        document.getElementById('meses_repetir').value = '';
    }
}

// Função para editar conta
async function editarConta(id) {
    try {
        console.log('Editando conta ID:', id);
        
        // Buscar os dados da conta
        const response = await fetchWithAuth(`/api/contas-receber/${id}`);
        if (!response || !response.ok) {
            console.error('Erro ao buscar conta:', response);
            showError('Erro ao buscar dados da conta');
            return;
        }
        
        const conta = await response.json();
        console.log('Dados da conta:', conta);
        
        // Carregar dados dos dropdowns primeiro
        await carregarDadosDropdowns();
        
        // Preencher o modal com os dados da conta
        document.getElementById('modalTitle').textContent = 'Editar Conta a Receber';
        document.getElementById('contaReceberId').value = conta.id;
        document.getElementById('valor').value = conta.valor;
        document.getElementById('data_emissao').value = conta.data_emissao;
        document.getElementById('data_vencimento').value = conta.data_vencimento;
        document.getElementById('data_recebimento').value = conta.data_recebimento || '';
        document.getElementById('observacao').value = conta.observacao || '';
        document.getElementById('status').value = conta.status;
        document.getElementById('recorrente').checked = conta.recorrente || false;
        document.getElementById('meses_repetir').value = conta.meses_repetir || '';
        
        // Aguardar um pouco para os dropdowns carregarem
        setTimeout(() => {
            document.getElementById('origem').value = conta.origem;
            document.getElementById('conta_id').value = conta.conta_id;
            document.getElementById('fornecedor_doador_id').value = conta.fornecedor_doador_id;
            document.getElementById('categoria').value = conta.categoria;
        }, 200);
        
        // Mostrar/ocultar seção de recorrência
        const recorrenciaSection = document.getElementById('recorrenciaSection');
        if (recorrenciaSection) {
            recorrenciaSection.style.display = conta.recorrente ? 'block' : 'none';
        }
        
        // Abrir o modal
        const modalElement = document.getElementById('contaReceberModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log('Modal aberto');
        } else {
            console.error('Modal não encontrado');
            showError('Erro ao abrir modal de edição');
        }
        
    } catch (error) {
        console.error('Erro na função editarConta:', error);
        showError('Erro ao carregar dados da conta: ' + error.message);
    }
}

// Função para marcar conta como recebida
async function receberConta(id) {
    if (confirm('Marcar esta conta como recebida?')) {
        try {
            // Primeiro, buscar os dados atuais da conta
            const getResponse = await fetchWithAuth(`/api/contas-receber/${id}`);
            if (!getResponse || !getResponse.ok) {
                showError('Erro ao buscar dados da conta');
                return;
            }
            
            const contaAtual = await getResponse.json();
            
            // Atualizar apenas o status e data de recebimento
            const dataAtual = new Date().toISOString().split('T')[0];
            const dadosAtualizados = {
                ...contaAtual,
                status: 'Recebido',
                data_recebimento: dataAtual
            };
            
            const response = await fetchWithAuth(`/api/contas-receber/${id}`, {
                method: 'PUT',
                body: JSON.stringify(dadosAtualizados)
            });

            if (response && response.ok) {
                showSuccess('Conta marcada como recebida com sucesso!');
                carregarContasReceber();
            } else {
                showError('Erro ao marcar conta como recebida');
            }
        } catch (error) {
            console.error('Erro:', error);
            showError('Erro ao conectar com o servidor');
        }
    }
}

// Função para excluir conta
async function excluirConta(id) {
    if (confirm('Tem certeza que deseja excluir esta conta a receber?')) {
        try {
            const response = await fetchWithAuth(`/api/contas-receber/${id}`, {
                method: 'DELETE'
            });

            if (response && response.ok) {
                showSuccess('Conta a receber excluída com sucesso!');
                carregarContasReceber();
            } else if (response) {
                const errorMessage = await handleApiError(response, 'Erro ao excluir conta a receber');
                showError(errorMessage);
            } else {
                showError('Erro ao conectar com o servidor');
            }
        } catch (error) {
            console.error('Erro:', error);
            showError('Erro ao conectar com o servidor');
        }
    }
}

// Funções de filtro
let categoriasDisponiveis = [];
let origensDisponiveis = [];
let contasDisponiveis = [];

async function carregarDadosFiltros() {
    const token = localStorage.getItem('access_token');
    const headers = { 
        'Authorization': 'Bearer ' + token, 
        'Content-Type': 'application/json' 
    };
    
    try {
        // Carregar Categorias para filtro
        const categoriasResp = await fetch('/api/categorias-receber', { headers });
        if (categoriasResp.ok) {
            categoriasDisponiveis = await categoriasResp.json();
        }
        
        // Carregar Origens para filtro
        const origensResp = await fetch('/api/origens-receber', { headers });
        if (origensResp.ok) {
            origensDisponiveis = await origensResp.json();
        }
        
        // Carregar Contas para filtro
        const contasResp = await fetch('/api/contas', { headers });
        if (contasResp.ok) {
            contasDisponiveis = await contasResp.json();
        }
        
    } catch (error) {
        console.error('Erro ao carregar dados dos filtros:', error);
    }
}

function aplicarFiltros() {
    const status = document.getElementById('filterStatus').value;
    const nomeRazao = document.getElementById('filterNomeRazao').value.toLowerCase();
    const categoriasSelecionadas = document.getElementById('categoriasSelecionadas').value;
    const origensSelecionadas = document.getElementById('origensSelecionadas').value;
    const contasSelecionadas = document.getElementById('contasSelecionadas').value;
    const dataInicio = document.getElementById('dataVencimentoInicio').value;
    const dataFim = document.getElementById('dataVencimentoFim').value;
    
    let contasFiltradas = [...contasReceber];
    
    // Filtro por status
    if (status) {
        contasFiltradas = contasFiltradas.filter(conta => conta.status === status);
    }
    
    // Filtro por nome/razão
    if (nomeRazao) {
        contasFiltradas = contasFiltradas.filter(conta => 
            conta.fornecedor_doador && conta.fornecedor_doador.nome_razao.toLowerCase().includes(nomeRazao)
        );
    }
    
    // Filtro por categorias (múltiplas)
    if (categoriasSelecionadas) {
        const categorias = categoriasSelecionadas.split(',');
        contasFiltradas = contasFiltradas.filter(conta => 
            categorias.includes(conta.categoria)
        );
    }
    
    // Filtro por origens (múltiplas)
    if (origensSelecionadas) {
        const origens = origensSelecionadas.split(',');
        contasFiltradas = contasFiltradas.filter(conta => 
            origens.includes(conta.origem)
        );
    }
    
    // Filtro por contas (múltiplas)
    if (contasSelecionadas) {
        const contas = contasSelecionadas.split(',');
        contasFiltradas = contasFiltradas.filter(conta => {
            // Verificar se a conta tem dados relacionados
            if (conta.conta && conta.conta.nome_conta) {
                return contas.includes(conta.conta.nome_conta);
            }
            // Se não tem dados relacionados, buscar pelo conta_id
            if (conta.conta_id && contasDisponiveis && contasDisponiveis.length > 0) {
                const contaEncontrada = contasDisponiveis.find(c => c.id == conta.conta_id);
                return contaEncontrada && contas.includes(contaEncontrada.nome_conta);
            }
            return false;
        });
    }
    
    // Filtro por período de vencimento
    if (dataInicio && dataFim) {
        contasFiltradas = contasFiltradas.filter(conta => {
            const dataVencimento = new Date(conta.data_vencimento);
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            return dataVencimento >= inicio && dataVencimento <= fim;
        });
    }
    
    // Atualizar a variável global com os dados filtrados
    const contasOriginais = [...contasReceber];
    contasReceber = contasFiltradas;
    
    // Resetar para primeira página
    paginaAtual = 1;
    
    // Renderizar tabela com dados filtrados
    renderizarTabela();
    
    // Restaurar dados originais
    contasReceber = contasOriginais;
}

function limparFiltros() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterNomeRazao').value = '';
    document.getElementById('filterCategoria').value = '';
    document.getElementById('categoriasSelecionadas').value = '';
    document.getElementById('filterOrigem').value = '';
    document.getElementById('origensSelecionadas').value = '';
    document.getElementById('filterConta').value = '';
    document.getElementById('contasSelecionadas').value = '';
    document.getElementById('filterPeriodoVencimento').value = '';
    document.getElementById('dataVencimentoInicio').value = '';
    document.getElementById('dataVencimentoFim').value = '';
    
    // Recarregar dados sem filtros
    carregarContasReceber();
}

function abrirModalCategorias() {
    // Criar modal para seleção múltipla de categorias
    const modalHtml = `
        <div class="modal fade" id="categoriasModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Selecionar Categorias</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selecionarTodasCategorias()">Selecionar Todas</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoCategorias()">Limpar Seleção</button>
                        </div>
                        <div id="categoriasCheckboxes">
                            ${categoriasDisponiveis.map(cat => `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${cat.nome}" id="cat_${cat.id}">
                                    <label class="form-check-label" for="cat_${cat.id}">
                                        ${cat.nome}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="aplicarCategorias()">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente se houver
    const modalExistente = document.getElementById('categoriasModal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    // Adicionar modal ao body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Marcar categorias já selecionadas
    const categoriasSelecionadas = document.getElementById('categoriasSelecionadas').value;
    if (categoriasSelecionadas) {
        const categorias = categoriasSelecionadas.split(',');
        categorias.forEach(categoria => {
            const checkbox = document.querySelector(`input[value="${categoria}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('categoriasModal'));
    modal.show();
}

function abrirModalOrigens() {
    // Criar modal para seleção múltipla de origens
    const modalHtml = `
        <div class="modal fade" id="origensModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Selecionar Origens</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selecionarTodasOrigens()">Selecionar Todas</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoOrigens()">Limpar Seleção</button>
                        </div>
                        <div id="origensCheckboxes">
                            ${origensDisponiveis.map(origem => `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${origem.nome}" id="orig_${origem.id}">
                                    <label class="form-check-label" for="orig_${origem.id}">
                                        ${origem.nome}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="aplicarOrigens()">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente se houver
    const modalExistente = document.getElementById('origensModal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    // Adicionar modal ao body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Marcar origens já selecionadas
    const origensSelecionadas = document.getElementById('origensSelecionadas').value;
    if (origensSelecionadas) {
        const origens = origensSelecionadas.split(',');
        origens.forEach(origem => {
            const checkbox = document.querySelector(`input[value="${origem}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('origensModal'));
    modal.show();
}

function selecionarTodasCategorias() {
    const checkboxes = document.querySelectorAll('#categoriasCheckboxes input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function limparSelecaoCategorias() {
    const checkboxes = document.querySelectorAll('#categoriasCheckboxes input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

function selecionarTodasOrigens() {
    const checkboxes = document.querySelectorAll('#origensCheckboxes input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function limparSelecaoOrigens() {
    const checkboxes = document.querySelectorAll('#origensCheckboxes input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

function aplicarCategorias() {
    const checkboxes = document.querySelectorAll('#categoriasCheckboxes input[type="checkbox"]:checked');
    const categoriasSelecionadas = Array.from(checkboxes).map(cb => cb.value);
    
    document.getElementById('categoriasSelecionadas').value = categoriasSelecionadas.join(',');
    
    if (categoriasSelecionadas.length > 0) {
        const texto = categoriasSelecionadas.length === 1 
            ? categoriasSelecionadas[0] 
            : `${categoriasSelecionadas.length} categorias selecionadas`;
        document.getElementById('filterCategoria').value = texto;
    } else {
        document.getElementById('filterCategoria').value = '';
    }
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('categoriasModal')).hide();
    
    // Aplicar filtros
    aplicarFiltros();
}

function aplicarOrigens() {
    const checkboxes = document.querySelectorAll('#origensCheckboxes input[type="checkbox"]:checked');
    const origensSelecionadas = Array.from(checkboxes).map(cb => cb.value);
    
    document.getElementById('origensSelecionadas').value = origensSelecionadas.join(',');
    
    if (origensSelecionadas.length > 0) {
        const texto = origensSelecionadas.length === 1 
            ? origensSelecionadas[0] 
            : `${origensSelecionadas.length} origens selecionadas`;
        document.getElementById('filterOrigem').value = texto;
    } else {
        document.getElementById('filterOrigem').value = '';
    }
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('origensModal')).hide();
    
    // Aplicar filtros
    aplicarFiltros();
}

function abrirModalContas() {
    // Criar modal para seleção múltipla de contas
    const modalHtml = `
        <div class="modal fade" id="contasModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Selecionar Contas</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selecionarTodasContas()">Selecionar Todas</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoContas()">Limpar Seleção</button>
                        </div>
                        <div id="contasCheckboxes">
                            ${contasDisponiveis.map(conta => `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${conta.nome_conta}" id="conta_${conta.id}">
                                    <label class="form-check-label" for="conta_${conta.id}">
                                        ${conta.nome_conta}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="aplicarContas()">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente se houver
    const modalExistente = document.getElementById('contasModal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    // Adicionar modal ao body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Marcar contas já selecionadas
    const contasSelecionadas = document.getElementById('contasSelecionadas').value;
    if (contasSelecionadas) {
        const contas = contasSelecionadas.split(',');
        contas.forEach(conta => {
            const checkbox = document.querySelector(`input[value="${conta}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('contasModal'));
    modal.show();
}

function selecionarTodasContas() {
    const checkboxes = document.querySelectorAll('#contasCheckboxes input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
}

function limparSelecaoContas() {
    const checkboxes = document.querySelectorAll('#contasCheckboxes input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
}

function aplicarContas() {
    const checkboxes = document.querySelectorAll('#contasCheckboxes input[type="checkbox"]:checked');
    const contasSelecionadas = Array.from(checkboxes).map(cb => cb.value);
    
    document.getElementById('contasSelecionadas').value = contasSelecionadas.join(',');
    
    if (contasSelecionadas.length > 0) {
        const texto = contasSelecionadas.length === 1 
            ? contasSelecionadas[0] 
            : `${contasSelecionadas.length} contas selecionadas`;
        document.getElementById('filterConta').value = texto;
    } else {
        document.getElementById('filterConta').value = '';
    }
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('contasModal')).hide();
    
    // Aplicar filtros
    aplicarFiltros();
}

function abrirCalendarioPeriodo() {
    // Criar modal simples para seleção de período
    const modalHtml = `
        <div class="modal fade" id="calendarioModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Selecionar Período de Vencimento</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dataInicio" class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="dataInicio">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dataFim" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="dataFim">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="aplicarPeriodo()">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente se houver
    const modalExistente = document.getElementById('calendarioModal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    // Adicionar modal ao body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('calendarioModal'));
    modal.show();
}

function aplicarPeriodo() {
    const dataInicio = document.getElementById('dataInicio').value;
    const dataFim = document.getElementById('dataFim').value;
    
    if (dataInicio && dataFim) {
        document.getElementById('dataVencimentoInicio').value = dataInicio;
        document.getElementById('dataVencimentoFim').value = dataFim;
        
        // Corrigir problema de fuso horário adicionando tempo local
        const dataInicioFormatada = new Date(dataInicio + 'T00:00:00').toLocaleDateString('pt-BR');
        const dataFimFormatada = new Date(dataFim + 'T00:00:00').toLocaleDateString('pt-BR');
        document.getElementById('filterPeriodoVencimento').value = `${dataInicioFormatada} - ${dataFimFormatada}`;
        
        // Fechar modal
        bootstrap.Modal.getInstance(document.getElementById('calendarioModal')).hide();
        
        // Aplicar filtros
        aplicarFiltros();
    } else {
        alert('Por favor, selecione ambas as datas.');
    }
}

// Controlar exibição da seção de recorrência
document.addEventListener('DOMContentLoaded', function() {
    if (isAuthenticated()) {
        carregarContasReceber();
        carregarDadosFiltros();
    }
    
    const recorrenteElement = document.getElementById('recorrente');
    if (recorrenteElement) {
        recorrenteElement.addEventListener('change', function() {
            const section = document.getElementById('recorrenciaSection');
            section.style.display = this.checked ? 'block' : 'none';
        });
    }
    
    // Preencher data de recebimento automaticamente quando status for "Recebido"
    const statusElement = document.getElementById('status');
    if (statusElement) {
        statusElement.addEventListener('change', function() {
            const dataRecebimento = document.getElementById('data_recebimento');
            if (this.value === 'Recebido') {
                // Preencher com a data atual se não estiver preenchida
                if (!dataRecebimento.value) {
                    dataRecebimento.value = new Date().toISOString().split('T')[0];
                }
            } else {
                // Limpar a data de recebimento se status não for "Recebido"
                dataRecebimento.value = '';
            }
        });
    }
});
</script>
{% endblock %}

